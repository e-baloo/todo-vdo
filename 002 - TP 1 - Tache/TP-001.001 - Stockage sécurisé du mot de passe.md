# ğŸ” Stockage sÃ©curisÃ© du mot de passe (bcrypt + NestJS)

**ğŸ¯ Objectifs pÃ©dagogiques**

Ã€ la fin de ce TP, lâ€™Ã©lÃ¨ve saura :

Comprendre pourquoi il ne faut jamais stocker un mot de passe en clair

Utiliser bcrypt pour hacher un mot de passe Ã  lâ€™inscription

VÃ©rifier un mot de passe lors de la connexion

**ğŸ“¦ PrÃ©requis**

Projet NestJS dÃ©jÃ  initialisÃ©

ModÃ¨le User avec un champ password

Mongoose configurÃ©

Avoir dÃ©jÃ  fait un endpoint /auth/register

## ğŸ§° Ã‰tape 1 â€“ Installer bcrypt
```bash
pnpm install bcrypt
pnpm install @types/bcrypt --save-dev
```

## ğŸ› ï¸ Ã‰tape 2 â€“ CrÃ©ation du service AuthService

ğŸ“ src/auth/auth.service.ts

```typescript
import { Injectable } from '@nestjs/common';
import * as bcrypt from 'bcrypt';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { User, UserDocument } from '../users/schemas/user.schema';

@Injectable()
export class AuthService {
  constructor(@InjectModel(User.name) private userModel: Model<UserDocument>) {}

  async register(name: string, email: string, password: string): Promise<User> {
    const saltOrRounds = 10;
    const hashedPassword = await bcrypt.hash(password, saltOrRounds);

    const createdUser = new this.userModel({ name, email, password: hashedPassword });
    return createdUser.save();
  }
}
```

## ğŸ§ª Ã‰tape 3 â€“ Test manuel dans un contrÃ´leur

ğŸ“ src/auth/auth.controller.ts

```typescript
import { Controller, Post, Body } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Post('register')
  async register(@Body() body: { name: string; email: string; password: string }) {
    return this.authService.register(body.name, body.email, body.password);
  }
}
```

## ğŸ§¼ Ã‰tape 4 â€“ Exercice Ã©lÃ¨ve (hachage + vÃ©rification)

ğŸ”¹ Partie 1 â€“ Hash le mot de passe Ã  l'inscription
ImplÃ©menter une fonction register() qui hash le mot de passe avant sauvegarde.

ğŸ”¹ Partie 2 â€“ VÃ©rifie le mot de passe Ã  la connexion

Ajouter dans auth.service.ts :

```typescript
ts
Copier
Modifier
async validateUser(email: string, plainPassword: string): Promise<boolean> {
  const user = await this.userModel.findOne({ email });
  if (!user) return false;

  const passwordMatch = await bcrypt.compare(plainPassword, user.password);
  return passwordMatch;
}
```

ğŸ§  Pour aller plus loin (questions)

Que se passe-t-il si deux utilisateurs ont le mÃªme mot de passe ?

Pourquoi utilise-t-on un sel (salt) dans le hachage ?

Est-ce quâ€™on peut dÃ©chiffrer un mot de passe hachÃ© ?

âœ… Validation
Inscription :

Lâ€™utilisateur est crÃ©Ã© avec un mot de passe hachÃ© (vÃ©rifier dans MongoDB)

Connexion :

Si lâ€™email + mot de passe sont bons, validateUser() retourne true