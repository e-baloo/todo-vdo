# 🔐 Stockage sécurisé du mot de passe (bcrypt + NestJS)

**🎯 Objectifs pédagogiques**

À la fin de ce TP, l’élève saura :

Comprendre pourquoi il ne faut jamais stocker un mot de passe en clair

Utiliser bcrypt pour hacher un mot de passe à l’inscription

Vérifier un mot de passe lors de la connexion

**📦 Prérequis**

Projet NestJS déjà initialisé

Modèle User avec un champ password

Mongoose configuré

Avoir déjà fait un endpoint /auth/register

## 🧰 Étape 1 – Installer bcrypt
```bash
pnpm install bcrypt
pnpm install @types/bcrypt --save-dev
```

## 🛠️ Étape 2 – Création du service AuthService

📁 src/auth/auth.service.ts

```typescript
import { Injectable } from '@nestjs/common';
import * as bcrypt from 'bcrypt';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { User, UserDocument } from '../users/schemas/user.schema';

@Injectable()
export class AuthService {
  constructor(@InjectModel(User.name) private userModel: Model<UserDocument>) {}

  async register(name: string, email: string, password: string): Promise<User> {
    const saltOrRounds = 10;
    const hashedPassword = await bcrypt.hash(password, saltOrRounds);

    const createdUser = new this.userModel({ name, email, password: hashedPassword });
    return createdUser.save();
  }
}
```

## 🧪 Étape 3 – Test manuel dans un contrôleur

📁 src/auth/auth.controller.ts

```typescript
import { Controller, Post, Body } from '@nestjs/common';
import { AuthService } from './auth.service';

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Post('register')
  async register(@Body() body: { name: string; email: string; password: string }) {
    return this.authService.register(body.name, body.email, body.password);
  }
}
```

## 🧼 Étape 4 – Exercice élève (hachage + vérification)

🔹 Partie 1 – Hash le mot de passe à l'inscription
Implémenter une fonction register() qui hash le mot de passe avant sauvegarde.

🔹 Partie 2 – Vérifie le mot de passe à la connexion

Ajouter dans auth.service.ts :

```typescript
ts
Copier
Modifier
async validateUser(email: string, plainPassword: string): Promise<boolean> {
  const user = await this.userModel.findOne({ email });
  if (!user) return false;

  const passwordMatch = await bcrypt.compare(plainPassword, user.password);
  return passwordMatch;
}
```

🧠 Pour aller plus loin (questions)

Que se passe-t-il si deux utilisateurs ont le même mot de passe ?

Pourquoi utilise-t-on un sel (salt) dans le hachage ?

Est-ce qu’on peut déchiffrer un mot de passe haché ?

✅ Validation
Inscription :

L’utilisateur est créé avec un mot de passe haché (vérifier dans MongoDB)

Connexion :

Si l’email + mot de passe sont bons, validateUser() retourne true